<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cast Your Vote | OVS</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="form.css">
</head>
<body>
    <!-- Navbar -->
    <nav>
        <div class="logo">üó≥Ô∏è OVS</div>
        <div class="hamburger">
            <span></span>
            <span></span>
            <span></span>
        </div>
        <ul>
            <li><a href="index.html">Home</a></li>
            <li><a href="voter-login.html">Voter</a></li>
            <li><a href="candidate-login.html">Candidate</a></li>
            <li><a href="admin-login.html">Admin</a></li>
            <li><a href="results.html">Results</a></li>
        </ul>
    </nav>

    <!-- Overlay + Page Content -->
    <div class="overlay">
        <h2>Cast Your Vote</h2>
        <p id="welcomeMsg" style="color: #32B8C6; margin-bottom: 10px;"></p>
        <form id="voteForm">
            <label for="candidate">Select Candidate:</label>
            <select id="candidate" required>
                <option value="">Loading candidates‚Ä¶</option>
            </select>
            <button type="submit">Submit Vote</button>
        </form>
        <p id="message"></p>
    </div>

    <!-- Footer -->
    <footer>
        ¬© 2025 Online Voting System | All Rights Reserved
    </footer>

    <!-- Script -->
    <script>
        // Check if voter is logged in
        window.onload = function() {
            let voterName = localStorage.getItem('voterName');
            let voterId = localStorage.getItem('voterId');
            
            if (!voterId) {
                alert('Please login first!');
                window.location.href = 'voter-login.html';
                return;
            }
            
            // Display welcome message
            if (voterName) {
                document.getElementById('welcomeMsg').textContent = `Welcome, ${voterName}!`;
            }
            
            fetchCandidates();
        };

        // Load candidates on page load
        function fetchCandidates() {
            fetch('http://127.0.0.1:8080/api/candidates')
                .then(response => response.json())
                .then(data => {
                    let select = document.getElementById('candidate');
                    select.innerHTML = '<option value="">Select a candidate</option>'; // Clear placeholder
                    
                    // Filter only approved candidates
                    let approvedCandidates = data.filter(c => c.approved === true);
                    
                    if (approvedCandidates.length === 0) {
                        select.innerHTML = '<option value="">No candidates available</option>';
                        return;
                    }
                    
                    approvedCandidates.forEach(c => {
                        var option = document.createElement('option');
                        option.value = c.candidateId;
                        option.textContent = c.name;
                        select.appendChild(option);
                    });
                })
                .catch(() => {
                    document.getElementById('candidate').innerHTML = "<option value=''>Failed to load candidates</option>";
                });
        }

        // Submit vote
        document.getElementById('voteForm').addEventListener('submit', function (e) {
            e.preventDefault();
            
            let candidateId = parseInt(document.getElementById('candidate').value, 10);
            let electionId = 1; // Use your actual electionId
            let voterId = parseInt(localStorage.getItem('voterId'), 10);

            if (!candidateId) {
                document.getElementById('message').textContent = "Please select a candidate.";
                document.getElementById('message').style.color = "red";
                return;
            }

            if (!voterId) {
                document.getElementById('message').textContent = "Session expired. Please login again.";
                document.getElementById('message').style.color = "red";
                setTimeout(() => window.location.href = 'voter-login.html', 2000);
                return;
            }

            // ‚úÖ Send voterId, candidateId, and electionId
            fetch('http://127.0.0.1:8080/api/votes/cast', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 
                    voterId: voterId,
                    candidateId: candidateId, 
                    electionId: electionId 
                })
            })
            .then(response => response.text())
            .then(data => {
                document.getElementById('message').innerText = data;
                
                if (data.includes('successfully')) {
                    document.getElementById('message').style.color = "green";
                    
                    // Clear localStorage and redirect after 3 seconds
                    setTimeout(() => {
                        localStorage.removeItem('voterId');
                        localStorage.removeItem('voterName');
                        alert('Thank you for voting! You will be redirected to home page.');
                        window.location.href = 'index.html';
                    }, 3000);
                } else {
                    document.getElementById('message').style.color = "red";
                }
            })
            .catch(err => {
                document.getElementById('message').innerText = "Error: " + err;
                document.getElementById('message').style.color = "red";
            });
        });
    </script>
    <script src="navbar.js"></script>
</body>
</html>
